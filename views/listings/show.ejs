<% layout("layouts/boilerplate") %>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = <%- JSON.stringify(listing) %>;
</script>

<section class="container my-5">
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow rounded-4 overflow-hidden position-relative">
        <img src="<%= listing.image?.url || '/images/default.jpg' %>" class="card-img-top" style="object-fit: cover; height: 25rem;" />

        <!-- Wishlist Button -->
        <% if (currentUser && currentUser.role === "client") { %>
          <button class="wishlist-toggle position-absolute top-0 end-0 m-3 fs-3 bg-white rounded-circle border-0 px-2 py-1 shadow
            <%= currentUser.wishlist.includes(listing._id) ? 'wishlisted' : '' %>"
            data-id="<%= listing._id %>">
            <%= currentUser.wishlist.includes(listing._id) ? '‚ù§Ô∏è' : 'ü§ç' %>
          </button>
        <% } else if (!currentUser && guestWishlist.includes(listing._id.toString())) { %>
          <button class="wishlist-toggle position-absolute top-0 end-0 m-3 fs-3 bg-white rounded-circle border-0 px-2 py-1 shadow wishlisted"
            data-id="<%= listing._id %>">‚ù§Ô∏è</button>
        <% } else if (!currentUser) { %>
          <button class="wishlist-toggle position-absolute top-0 end-0 m-3 fs-3 bg-white rounded-circle border-0 px-2 py-1 shadow"
            data-id="<%= listing._id %>">ü§ç</button>
        <% } %>

        <div class="card-body">
          <h2 class="card-title mb-2"><%= listing.title %></h2>
          <h5 class="text-muted mb-3"><%= listing.location %>, <%= listing.country %></h5>
          <p><strong>Price:</strong> ‚Çπ<%= listing.price.toLocaleString("en-IN") %> / night</p>
          <p><%= listing.description %></p>
          <p class="text-secondary"><i>Listed by: <%= listing.owner?.username || "Unknown" %></i></p>

          <% if (!currentUser) { %>
            <a href="/login" class="btn btn-warning btn-lg mt-3">Login to Book</a>
          <% } else if (currentUser.role === "client") { %>
            <a href="/bookings/<%= listing._id %>/checkout" class="btn btn-success btn-lg mt-3">Book Now</a>
          <% } %>
        </div>
      </div>

      <% if (currentUser && listing.owner && listing.owner._id.toString() === currentUser._id.toString()) { %>
        <div class="mt-3 d-flex gap-3">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">Edit</a>
          <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
            <button class="btn btn-danger">Delete</button>
          </form>
        </div>
      <% } %>

      <!-- Reviews -->
      <div class="mt-5">
        <h3>Reviews</h3>

        <% if (currentUser && currentUser.role === 'client') { %>
          <button class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#reviewModal">Leave a Review</button>
        <% } %>

        <% if (listing.reviews.length === 0) { %>
          <div class="alert alert-info">No reviews yet.</div>
        <% } else { %>
          <% listing.reviews.forEach(review => { %>
            <div class="card mb-3 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <h5><%= review.author?.username || "Unknown" %></h5>
                  <% if (currentUser && review.author && currentUser._id.toString() === review.author._id.toString()) { %>
                    <div>
                      <a href="/listings/<%= listing._id %>/reviews/<%= review._id %>/edit" class="btn btn-sm btn-warning">Edit</a>
                      <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline">
                        <button class="btn btn-sm btn-danger">Delete</button>
                      </form>
                    </div>
                  <% } %>
                </div>
                <p class="mb-0"><%= review.comment %></p>
                <div class="text-warning mt-2">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="fa <%= i <= review.rating ? 'fa-star' : 'fa-star-o' %>"></i>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <!-- Map -->
      <div class="mt-5">
        <h3>Where you'll be</h3>
        <div id="map" class="rounded shadow" style="height: 300px;"></div>
      </div>
    </div>
  </div>
</section>

<!-- Review Modal -->
<% if (currentUser && currentUser.role === 'client') { %>
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="/listings/<%= listing._id %>/reviews" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="reviewModalLabel">Leave a Review</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Rating</label>
              <div class="star-rating">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="fa fa-star" data-value="<%= i %>"></i>
                <% } %>
                <input type="hidden" name="review[rating]" id="ratingValue" value="0" required />
              </div>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Comment</label>
              <textarea name="review[comment]" id="comment" class="form-control" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
<% } %>

<style>
  .star-rating i {
    font-size: 1.5rem;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .star-rating i:hover,
  .star-rating i.hovered {
    transform: scale(1.2);
    color: orange;
  }

  .star-rating i.selected {
    color: orange;
  }
</style>

<script src="/js/map.js"></script>
<script src="/js/review.js"></script>
<script>
  const stars = document.querySelectorAll(".star-rating i");
  const ratingInput = document.getElementById("ratingValue");

  stars.forEach(star => {
    star.addEventListener("mouseover", () => {
      stars.forEach(s => s.classList.remove("hovered"));
      for (let i = 0; i < +star.dataset.value; i++) {
        stars[i].classList.add("hovered");
      }
    });

    star.addEventListener("mouseout", () => {
      stars.forEach(s => s.classList.remove("hovered"));
    });

    star.addEventListener("click", () => {
      ratingInput.value = star.dataset.value;
      stars.forEach(s => s.classList.remove("selected"));
      for (let i = 0; i < +star.dataset.value; i++) {
        stars[i].classList.add("selected");
      }
    });
  });

  const toggleWishlist = async (id, btn) => {
    const res = await fetch(`/wishlist/toggle/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    btn.innerHTML = data.inWishlist ? "‚ù§Ô∏è" : "ü§ç";
    btn.classList.toggle("wishlisted", data.inWishlist);
    if (data.guest) {
      let guestWishlist = JSON.parse(localStorage.getItem("guestWishlist") || "[]");
      if (data.inWishlist && !guestWishlist.includes(id)) guestWishlist.push(id);
      if (!data.inWishlist) guestWishlist = guestWishlist.filter(x => x !== id);
      localStorage.setItem("guestWishlist", JSON.stringify(guestWishlist));
    }
  };

  document.querySelectorAll(".wishlist-toggle").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      toggleWishlist(btn.dataset.id, btn);
    });
  });
</script>
